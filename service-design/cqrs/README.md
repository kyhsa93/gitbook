# CQRS

CQRS 란 Command Query Responsibility Segregation 의 약자로 Application 의 Command 와 Query 를 분리하여 구현하는 Pattern 을 말합니다. 이는 Command \(Create, Update, Delete\) 와 Query \(Read\) 를 분리하여 복잡한 Domain model 을 구현하고, 요구사항 변경으로 인한 Domain Model 의 변질을 방지할 수 있습니다.

CQRS 는 분리 구현의 수준과 Event sourcing 구현 여부로 구현의 단계를 구분해볼수 있습니다. 가장 처음 쉽게 구현해볼 수 있는 구조는 하나의 어플리케이션 내부에서 구현을 분리하는 것입니다. Command 와 Query 를 각각의 서비스로 분리구현하고 하나의 데이터베이스를 사용하도록하여 구조를 어플리케이션 내부로 제한하고 복잡도를 간단하게 가져갈 수 있는 방법입니다. 이때 도메인에 대한 접근은 Command 에서만 이루어지게 하여 Query 로 인한 변경이 도메인과 연결되지 않도록 해야합니다. 

다음으로 조금 더 구현 수준을 높여보면 Command 와 Query 를 각각의 어플리케이션으로 분리 구현하고 데이터베이스까지 따로 사용하도록 하는것 입니다. 이때부터 CQRS 의 구현이 어플리케이션 외부의 범위로 넘어가게되며 데이터베이스 동기화 등의 이슈가 발생합니다. 데이터베이스 동기화 이슈는 Command 어플리케이션에서 변경을 진행하고 데이터베이스에 적용하는동안 Query 어플리케이션에서 사용하는 데이터베이스에 이 변경 사항이 적용되는데까지 시간이 필요하게 됩니다. 이 때문에 데이터에 변경은 일어났으나 변경사항이 조회된 데이터에 반영이 되지 않을 수 있고 이를 해결해야하는 문제가 발생합니다.

마지막으로 Event sourcing 이 적용된 모델은 Command 어플리케이션에서 일어난 모든 Event 를 저장하는데에서부터 시작합니다. Command 어플리케이션은 발생한 모든 Event 를 Event store 에 저장합니다. 그리고 데이터 조회를 담당하는 Query 어플리케이션은 Event store 에 저장된 Event 들을 구체화하여 클라이언트에게 전달하게 됩니다. 이 구조에서는 구현 복잡도가 매우 크게 상승하며 Command 에서 저장된 Event 들을 어떻게 구체화하여 Query 가 사용할 수 있을지에 대한 기술적인 고민이 필요합니다. Event bus 등을 사용하여 발생한 Event 를 Query 가 사용하는 데이터베이스로 파이프하고 매번 데이터를 구체화하게 할 수 있으며, 데이터베이스 스냅샷과 Event 구체화를 동시에 사용하여 구체화할 Event 를 일정량 이상 넘지않도록 구현할 수도 있습니다. 

CQRS 의 구현에 있어서는 가장 중요한 것은 시스템과 비지니스 규모에 맞게 구조를 설계하고 구현하는 것입니다. 점점 CQRS 모델을 발전시켜나가는 것은 어플리케이션과 데이터베이스의 분리, Event sourcing 으로 Command 와 Query 가 서로 간섭받지않고 독립적으로 동작할 수 있도록 하지만 이는 점점 시스템의 구조가 복잡해지고, 그만큼 구현 복잡도와 유지관리 포인트, 거대한 시스템으로 인한 성능 저하를 불러올 수 있습니다. 다만 이를 잘 알고 알맞게 활용한다면 더 발전할 수 있는 시스템을 만들수 있는 아주 좋은 도구로 사용될 수 있다고 생각합니다.

